<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î—Î¼ÎµÏÎ¿Î»ÏŒÎ³Î¹Î¿ Î•ÎÎ¦Î¡</title>
    <style>
        :root { --green: #1b5e20; --blue: #0d47a1; --red: #b71c1c; --gold: #fbc02d; --sat-bg: #e3f2fd; --sun-bg: #ffebee; --hol-bg: #ffcdd2; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 5px; background: #f0f0f0; }
        .main-card { max-width: 1100px; margin: auto; background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .header { background: var(--green); color: white; padding: 10px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .header input, .header select { font-weight: bold; border-radius: 4px; border: none; padding: 10px; width: 100%; font-size: 14px; margin-top: 4px; }
        .month-totals { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 10px; background: #e8f5e9; border-bottom: 2px solid var(--green); }
        .total-box { background: white; padding: 8px 2px; border-radius: 5px; text-align: center; border: 1px solid #c8e6c9; }
        .total-label { font-size: 9px; font-weight: bold; color: #444; display: block; }
        .total-val { font-size: 14px; font-weight: 900; color: var(--green); }
        .peran-val { color: #e65100; }
        .weeks-banner { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 10px; background: #fffde7; border-bottom: 3px solid var(--gold); }
        .w-tile { background: white; border: 1px solid #ccc; padding: 5px; border-radius: 5px; text-align: center; font-size: 10px; line-height: 1.3; }
        .w-val { font-weight: 900; font-size: 13px; display: block; margin-top: 2px; }
        .w-upk { color: var(--blue); }
        .w-upa { color: var(--red); }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        td { border: 1px solid #bbb; height: 110px; vertical-align: top; padding: 4px; cursor: pointer; background: white; overflow: hidden; position: relative; }
        .sat-cell { background: var(--sat-bg) !important; color: var(--blue); }
        .sun-cell { background: var(--sun-bg) !important; color: var(--red); }
        .holiday-cell { background: var(--hol-bg) !important; color: var(--red); border: 2.5px solid var(--red) !important; }
        .day-num { font-weight: 900; font-size: 16px; }
        .shift-tag { background: var(--blue); color: white; font-size: 9px; padding: 2px; border-radius: 3px; display: block; margin-top: 2px; text-align: center; font-weight: bold; }
        .day-note { font-size: 11px; color: #000; font-weight: 900; display: block; margin-top: 4px; line-height: 1.2; border-top: 1px solid #eee; padding-top: 2px; }
        .footer { padding: 15px; background: #fafafa; border-top: 4px solid var(--green); }
        .money-line { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 6px 0; font-size: 14px; font-weight: 900; }
        .backup-btns { display: flex; gap: 5px; padding: 10px; background: #eee; justify-content: center; }
        .btn-b { padding: 10px; font-size: 11px; font-weight: bold; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; background: white; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: white; width: 95%; max-width: 580px; margin: 5px auto; padding: 15px; border-radius: 10px; max-height: 95vh; overflow-y: auto; }
        .m-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; }
        .m-btn { padding: 12px 5px; border: 1px solid #ccc; background: #f5f5f5; font-weight: bold; cursor: pointer; font-size: 11px; display: flex; justify-content: space-between; align-items: center; }
        .m-rate { color: var(--red); font-weight: 900; }
        .add-shift-btn { 
            background: var(--green); 
            color: white; 
            border: none; 
            padding: 5px 10px; 
            border-radius: 3px; 
            font-size: 11px; 
            cursor: pointer;
            margin: 5px 0;
        }
        .shift-section { margin-bottom: 10px; }
    </style>
</head>
<body>
<div class="main-card">
    <div class="header">
        <div class="top-row"><b>Î•ÎÎ¦Î¡</b>
            <div><button onclick="nav(-1)">â—„</button> <span id="month-label"></span> <button onclick="nav(1)">â–º</button></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <div><label style="font-size:10px">Î’Î‘Î£Î™ÎšÎŸÎ£ ÎšÎ›Î™ÎœÎ‘ÎšÎ™ÎŸÎ¥</label><input type="number" id="salary" oninput="saveSalary()"></div>
            <div><label style="font-size:10px">Î©Î¡Î‘Î¡Î™ÎŸ</label>
                <select id="mode-sel" onchange="saveMode()">
                    <option value="34">Î©ÏÎ¬ÏÎ¹Î¿ 34h</option>
                    <option value="29">ÎœÎµÎ¹Ï‰Î¼Î­Î½Î¿ 29h</option>
                    <option value="24">ÎœÎµÎ¹Ï‰Î¼Î­Î½Î¿ 24h</option>
                </select>
            </div>
        </div>
    </div>
    <div class="month-totals">
        <div class="total-box"><span class="total-label">Î£Î¥Î. Î£Î¤ÎŸÎ§ÎŸÎ¥</span><span class="total-val" id="m-target">0.0</span></div>
        <div class="total-box"><span class="total-label">Î£Î¥Î. Î¥Î Îš</span><span class="total-val" id="m-upk">0.0</span></div>
        <div class="total-box"><span class="total-label">Î£Î¥Î. Î¥Î Î‘</span><span class="total-val" id="m-upa">0.0</span></div>
        <div class="total-box"><span class="total-label">Î£Î¥Î. Î Î•Î¡Î‘Î</span><span class="total-val peran-val" id="m-peran">0.0</span></div>
    </div>
    <div class="weeks-banner" id="weeks-stats"></div>
    <table>
        <thead><tr><th>Î”Î•</th><th>Î¤Î¡</th><th>Î¤Î•</th><th>Î Î•</th><th>Î Î‘</th><th>Î£Î‘</th><th>ÎšÎ¥</th></tr></thead>
        <tbody id="cal-body"></tbody>
    </table>
    <div class="backup-btns">
        <button class="btn-b" onclick="exportData()">ğŸ’¾ Î•ÎÎ‘Î“Î©Î“Î— (SHARE)</button>
        <button class="btn-b" onclick="document.getElementById('importFile').click()">ğŸ“‚ Î•Î™Î£Î‘Î“Î©Î“Î— BACKUP</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>
    <div class="footer">
        <div class="money-line">Î£ÏÎ½Î¿Î»Î¿ Î©ÏÏÎ½: <b id="t-all">0.0</b></div>
        <div class="money-line">ÎœÎµÎ¹ÎºÏ„Î¬ Î ÏÏŒÏƒÎ¸ÎµÏ„Î±: <b id="r-gross">0.00â‚¬</b></div>
        <div class="money-line">ÎœÎ¤Î Î¥ (2%): <b id="r-mtpy" style="color:var(--red)">0.00â‚¬</b></div>
        <div class="money-line">Î•Î¹ÏƒÏ†Î¿ÏÎ¬ (2%): <b id="r-eis" style="color:var(--red)">0.00â‚¬</b></div>
        <div class="money-line">Î¦ÏŒÏÎ¿Ï‚ (20%): <b id="r-tax" style="color:var(--red)">0.00â‚¬</b></div>
        <div style="background:var(--green); color:white; padding:15px; text-align:center; font-size:2em; font-weight:900; border-radius:8px; margin-top:10px;" id="r-net">0.00â‚¬</div>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <div style="background:#e8f5e9; padding:10px; border:1px solid var(--green); border-radius:5px; margin-bottom:10px; display:flex; gap:5px;">
            <input type="text" id="cust-n" placeholder="ÎŒÎ½Î¿Î¼Î±" style="width:40%">
            <input type="number" id="cust-h" placeholder="Î©Ï" style="width:20%">
            <input type="number" id="cust-p" placeholder="â‚¬/Î©" style="width:20%">
            <button onclick="addCustomShift()" style="background:var(--green); color:white; border:none; padding:5px 10px; border-radius:3px;">OK</button>
        </div>
        <div class="m-grid" id="m-opts"></div>
        <hr>
        
        <!-- ÎœÎŸÎÎ¤Î•Î›ÎŸ ÎœÎ• 3 Î’Î‘Î¡Î”Î™Î•Î£ -->
        <div id="shift-container">
            <!-- Î’Î¬ÏÎ´Î¹Î± 1 -->
            <div class="shift-section" id="shift-1">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <label style="font-size:10px">Î’Î‘Î¡Î”Î™Î‘ 1</label>
                    <button class="add-shift-btn" onclick="addShiftField()" id="add-shift-btn">+ Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· 3Î·Ï‚ Î’Î¬ÏÎ´Î¹Î±Ï‚</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;">
                    <input type="text" id="c-n1" placeholder="Î¤ÏÏ€Î¿Ï‚" style="width:100%">
                    <input type="number" id="c-h1" step="0.1" placeholder="ÎÏÎµÏ‚" style="width:100%" oninput="recalcMoney(1)">
                    <input type="number" id="c-m1" step="0.01" placeholder="â‚¬" style="width:100%">
                </div>
            </div>
            
            <!-- Î’Î¬ÏÎ´Î¹Î± 2 -->
            <div class="shift-section" id="shift-2">
                <label style="font-size:10px">Î’Î‘Î¡Î”Î™Î‘ 2</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;">
                    <input type="text" id="c-n2" placeholder="Î¤ÏÏ€Î¿Ï‚" style="width:100%">
                    <input type="number" id="c-h2" step="0.1" placeholder="ÎÏÎµÏ‚" style="width:100%" oninput="recalcMoney(2)">
                    <input type="number" id="c-m2" step="0.01" placeholder="â‚¬" style="width:100%">
                </div>
            </div>
            
            <!-- Î’Î¬ÏÎ´Î¹Î± 3 (ÎºÏÏ…Ï†Î® Î±ÏÏ‡Î¹ÎºÎ¬) -->
            <div class="shift-section" id="shift-3" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <label style="font-size:10px">Î’Î‘Î¡Î”Î™Î‘ 3</label>
                    <button class="add-shift-btn" onclick="removeShiftField(3)" style="background: var(--red);">Ã— Î‘Ï†Î±Î¯ÏÎµÏƒÎ·</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;">
                    <input type="text" id="c-n3" placeholder="Î¤ÏÏ€Î¿Ï‚" style="width:100%">
                    <input type="number" id="c-h3" step="0.1" placeholder="ÎÏÎµÏ‚" style="width:100%" oninput="recalcMoney(3)">
                    <input type="number" id="c-m3" step="0.01" placeholder="â‚¬" style="width:100%">
                </div>
            </div>
        </div>
        
        <div style="margin-top:10px;">
            <input type="text" id="c-txt" placeholder="Î£Ï‡ÏŒÎ»Î¹Î¿..." style="width:100%; padding:8px; font-weight:900;">
        </div>
        
        <button onclick="save()" style="width:100%; padding:15px; background:var(--green); color:white; border:none; font-weight:bold; margin-top:15px; border-radius:5px;">Î‘Î ÎŸÎ˜Î—ÎšÎ•Î¥Î£Î—</button>
        <button onclick="del()" style="width:100%; margin-top:10px; padding:10px; background:var(--red); color:white; border:none;">Î”Î™Î‘Î“Î¡Î‘Î¦Î—</button>
        <button onclick="closeModal()" style="width:100%; margin-top:10px; padding:10px;">ÎšÎ›Î•Î™Î£Î™ÎœÎŸ</button>
    </div>
</div>

<script>
let cur = new Date(); 
let db = JSON.parse(localStorage.getItem('exfr_db_v53') || '{}');
let settings = JSON.parse(localStorage.getItem('exfr_settings') || '{"mode":"34","salary":1100}');
let customShifts = JSON.parse(localStorage.getItem('exfr_custom_v133') || '[]');
let activeInput = 'c-n1'; 
let selD = '';

const SHIFTS = [
    {n:'Î Î¡Î©Î™',h:8.5,s:0}, {n:'Î‘Î ÎŸÎ“Î•Î¥ÎœÎ‘',h:8.5,s:0}, {n:'1/2 Î©Î¡Î‘Î£',h:0.5,s:0},
    {n:'ÎÎ¥Î§Î¤Î‘',h:8,s:0.6}, {n:'Î‘Î¡Î“Î™Î‘',h:8,s:0.75}, {n:'Î Î•Î¡Î‘Î 5Î—Îœ',h:8,s:1.25},
    {n:'Î Î•Î¡.Î‘Î¡Î“.Î Î¡Î©Î™',h:8,s:1.42}, {n:'Î Î•Î¡.Î‘Î¡Î“.ÎÎ¥Î§Î¤',h:8,s:1.51},
    {n:'Î¥Î Î•Î¡.Î Î¡Î©Î™',h:1,s:1.0, isOT:true}, {n:'Î¥Î Î•Î¡.ÎÎ¥Î§Î¤Î‘',h:1,s:1.6, isOT:true},
    {n:'Î•Î™Î”Î™ÎšÎ— Î‘Î”Î•Î™Î‘',h:6.8,s:0,abs:true}, {n:'Î‘Î™ÎœÎŸÎ”ÎŸÎ¤Î™ÎšÎ—',h:6.8,s:0,abs:true},
    {n:'ÎšÎ‘Î. Î‘Î”Î•Î™Î‘',h:0,s:0,abs:true}, {n:'Î‘ÎÎ‘Î¡Î¡Î©Î¤Î™ÎšÎ—',h:0,s:0,abs:true}, 
    {n:'Î’Î¡Î‘Î§Î•Î™Î‘',h:0,s:0,abs:true}, {n:'ÎŸÎ¦ Î¡Î•Î ÎŸ',h:8.5,s:0}, {n:'Î‘Î”Î™Î‘Î˜Î•Î¤ÎŸ',h:0,s:0}, {n:'Î¡Î•Î ÎŸ',h:0,s:0}
];

function fmt(d) { return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }

function getHols(y) {
    let h = [fmt(new Date(y,0,1)), fmt(new Date(y,0,6)), fmt(new Date(y,2,25)), fmt(new Date(y,4,1)), fmt(new Date(y,7,15)), fmt(new Date(y,9,16)), fmt(new Date(y,9,28)), fmt(new Date(y,11,25)), fmt(new Date(y,11,26))];
    let a=y%19, d_val=(19*a+15)%30, e_val=(2*(y%4)+4*(y%7)+6*d_val+6)%7;
    let p=d_val+e_val+22+13; let m=3, day=p; if(day>31){day-=31; m=4;} if(day>30){day-=30; m=5;}
    let easter = new Date(y, m-1, day);
    const add = (diff) => { let tmp = new Date(easter); tmp.setDate(tmp.getDate() + diff); h.push(fmt(tmp)); };
    add(-48); add(-2); add(-1); add(0); add(1); add(50); return h;
}

// Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î•Î™Î£ Î•ÎÎ‘Î“Î©Î“Î—Î£/Î•Î™Î£Î‘Î“Î©Î“Î—Î£
function exportData() {
    const data = { 
        db, 
        settings, 
        customShifts,
        version: '3shifts_v1'
    };
    const jsonStr = JSON.stringify(data);
    
    if (navigator.share && /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        // Î§ÏÎ®ÏƒÎ· Web Share API Î³Î¹Î± ÎºÎ¹Î½Î·Ï„Î¬
        const blob = new Blob([jsonStr], {type: 'application/json'});
        const file = new File([blob], `exfr_backup_${Date.now()}.json`, {type: 'application/json'});
        
        navigator.share({
            title: 'Î•ÎÎ¦Î¡ Backup',
            text: 'Backup Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î±Ï€ÏŒ Î•ÎÎ¦Î¡ Î—Î¼ÎµÏÎ¿Î»ÏŒÎ³Î¹Î¿',
            files: [file]
        }).catch(() => {
            fallbackExport(jsonStr);
        });
    } else {
        fallbackExport(jsonStr);
    }
}

function fallbackExport(jsonStr) {
    const blob = new Blob([jsonStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `exfr_backup_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }, 100);
}

function importData(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if (data.db) {
                db = data.db;
                settings = data.settings || {"mode":"34","salary":1100};
                customShifts = data.customShifts || [];
                
                localStorage.setItem('exfr_db_v53', JSON.stringify(db));
                localStorage.setItem('exfr_settings', JSON.stringify(settings));
                localStorage.setItem('exfr_custom_v133', JSON.stringify(customShifts));
                
                alert("Î•Ï€Î¹Ï„Ï…Ï‡Î®Ï‚ ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®!");
                setTimeout(() => location.reload(), 500);
            }
        } catch(err) {
            alert("Î£Ï†Î¬Î»Î¼Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï…!");
        }
    };
    reader.readAsText(file);
}

// Î’Î‘Î£Î™ÎšÎ•Î£ Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î•Î™Î£
function saveSalary() {
    let monthKey = `sal_${cur.getFullYear()}-${cur.getMonth()}`;
    db[monthKey] = parseFloat(document.getElementById('salary').value) || 0;
    localStorage.setItem('exfr_db_v53', JSON.stringify(db));
    calculate();
}

function saveMode() {
    settings.mode = document.getElementById('mode-sel').value;
    localStorage.setItem('exfr_settings', JSON.stringify(settings));
    calculate();
}

function calculate() {
    const y = cur.getFullYear();
    const m = cur.getMonth();
    const monthKey = `sal_${y}-${m}`;
    const sal = db[monthKey] || settings.salary;
    const mB = parseFloat(settings.mode);
    const hols = getHols(y);
    
    document.getElementById('salary').value = sal;
    document.getElementById('mode-sel').value = settings.mode;
    document.getElementById('month-label').innerText = new Intl.DateTimeFormat('el-GR', {
        month: 'short',
        year: 'numeric'
    }).format(cur).toUpperCase();
    
    let start = (new Date(y, m, 1).getDay() + 6) % 7;
    let days = new Date(y, m + 1, 0).getDate();
    let tGross = 0;
    let tAll = 0;
    let weeks = Array.from({ length: 6 }, () => ({ days: [], target: 0, upk: 0, upa: 0 }));
    let monthT = 0;
    let monthUPK = 0;
    let monthUPA = 0;
    
    for (let d = 1; d <= days; d++) {
        let dObj = new Date(y, m, d);
        let dStr = fmt(dObj);
        let wIdx = Math.floor((d + start - 1) / 7);
        weeks[wIdx].days.push({ dStr, isH: hols.includes(dStr), dw: dObj.getDay(), s: db[dStr] });
    }
    
    weeks.forEach(w => {
        if (w.days.length === 0) return;
        let firstDay = new Date(w.days[0].dStr);
        let diff = (firstDay.getDay() + 6) % 7;
        let monday = new Date(firstDay);
        monday.setDate(firstDay.getDate() - diff);
        let holidayCount = 0;
        
        for (let i = 0; i < 7; i++) {
            let tempD = new Date(monday);
            tempD.setDate(monday.getDate() + i);
            let tempStr = fmt(tempD);
            if (getHols(tempD.getFullYear()).includes(tempStr) && tempD.getDay() >= 1 && tempD.getDay() <= 5) holidayCount++;
        }
        
        let adjustedMB = mB - (holidayCount * (mB / 5));
        let absenceDays = w.days.filter(d => d.s && d.s.abs).length;
        w.target = (adjustedMB / 7) * (w.days.length - absenceDays);
        if (w.target < 0) w.target = 0;
        w.upk = -w.target;
        
        w.days.forEach(day => {
            if (day.s) {
                // Î¥Î ÎŸÎ›ÎŸÎ“Î™Î£ÎœÎŸÎ£ ÎœÎ• 3 Î’Î‘Î¡Î”Î™Î•Î£
                const h1 = day.s.h1 || 0;
                const h2 = day.s.h2 || 0;
                const h3 = day.s.h3 || 0;
                const m1 = day.s.m1 || 0;
                const m2 = day.s.m2 || 0;
                const m3 = day.s.m3 || 0;
                
                tAll += (h1 + h2 + h3);
                tGross += (m1 + m2 + m3);
                
                let hc = (day.s.isOT1 ? 0 : h1) + (day.s.isOT2 ? 0 : h2) + (day.s.isOT3 ? 0 : h3);
                
                for (let i = 0; i < Math.round(hc * 10); i++) {
                    if (w.upk < -0.01) w.upk += 0.1;
                    else {
                        if (day.dw === 0 || day.isH) w.upa += 0.1;
                        else w.upk += 0.1;
                    }
                }
            }
        });
        
        monthT += w.target;
        monthUPK += w.upk;
        monthUPA += w.upa;
    });
    
    document.getElementById('m-target').innerText = monthT.toFixed(1);
    document.getElementById('m-upk').innerText = monthUPK.toFixed(1);
    document.getElementById('m-upa').innerText = monthUPA.toFixed(1);
    document.getElementById('m-peran').innerText = (monthUPK + monthUPA).toFixed(1);
    
    let body = document.getElementById('cal-body');
    body.innerHTML = '';
    let row = document.createElement('tr');
    
    for (let i = 0; i < start; i++) row.appendChild(document.createElement('td'));
    
    for (let d = 1; d <= days; d++) {
        if (row.children.length === 7) {
            body.appendChild(row);
            row = document.createElement('tr');
        }
        
        let dStr = fmt(new Date(y, m, d));
        let s = db[dStr];
        let isH = hols.includes(dStr);
        let dw = new Date(y, m, d).getDay();
        let cell = document.createElement('td');
        cell.onclick = () => openModal(dStr);
        
        if (isH) cell.className = 'holiday-cell';
        else if (dw === 0) cell.className = 'sun-cell';
        else if (dw === 6) cell.className = 'sat-cell';
        
        // Î Î¡ÎŸÎ£Î˜Î—ÎšÎ— ÎšÎ‘Î™ 3Î—Î£ Î’Î‘Î¡Î”Î™Î‘Î£ Î£Î¤Î—Î Î•ÎœÎ¦Î‘ÎÎ™Î£Î—
        let shiftTags = '';
        if (s) {
            if (s.t1) shiftTags += `<span class="shift-tag">${s.t1}</span>`;
            if (s.t2) shiftTags += `<span class="shift-tag">${s.t2}</span>`;
            if (s.t3) shiftTags += `<span class="shift-tag">${s.t3}</span>`;
        }
        
        cell.innerHTML = `<span class="day-num">${d}</span>${shiftTags}${s && s.txt ? `<span class="day-note">${s.txt}</span>` : ''}`;
        row.appendChild(cell);
    }
    
    body.appendChild(row);
    
    const wDiv = document.getElementById('weeks-stats');
    wDiv.innerHTML = '';
    weeks.forEach((w, i) => {
        if (w.days.length > 0) {
            wDiv.innerHTML += `<div class="w-tile"><b>Î•Î’Î”. ${i + 1}</b><br>Î£Î¤: <span class="w-val">${w.target.toFixed(1)}</span>Î¥Î Îš: <span class="w-val w-upk">${w.upk.toFixed(1)}</span>Î¥Î Î‘: <span class="w-val w-upa">${w.upa.toFixed(1)}</span></div>`;
        }
    });
    
    let mtpy = tGross * 0.02;
    let eis = tGross * 0.02;
    let tax = (tGross - mtpy - eis) * 0.20;
    
    document.getElementById('t-all').innerText = tAll.toFixed(1);
    document.getElementById('r-gross').innerText = tGross.toFixed(2) + 'â‚¬';
    document.getElementById('r-mtpy').innerText = mtpy.toFixed(2) + 'â‚¬';
    document.getElementById('r-eis').innerText = eis.toFixed(2) + 'â‚¬';
    document.getElementById('r-tax').innerText = tax.toFixed(2) + 'â‚¬';
    document.getElementById('r-net').innerText = (tGross - mtpy - eis - tax).toFixed(2) + 'â‚¬';
}

// ÎœÎŸÎÎ¤Î•Î›ÎŸ Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î•Î™Î£ ÎœÎ• 3 Î’Î‘Î¡Î”Î™Î•Î£
function openModal(d) {
    activeInput = 'c-n1';
    selD = d;
    renderShifts();
    
    let s = db[d] || {};
    
    // Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Ï€ÎµÎ´Î¯Ï‰Î½
    document.getElementById('c-n1').value = s.t1 || '';
    document.getElementById('c-h1').value = s.h1 || '';
    document.getElementById('c-m1').value = s.m1 || '';
    
    document.getElementById('c-n2').value = s.t2 || '';
    document.getElementById('c-h2').value = s.h2 || '';
    document.getElementById('c-m2').value = s.m2 || '';
    
    document.getElementById('c-n3').value = s.t3 || '';
    document.getElementById('c-h3').value = s.h3 || '';
    document.getElementById('c-m3').value = s.m3 || '';
    
    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· 3Î·Ï‚ Î²Î¬ÏÎ´Î¹Î±Ï‚ Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±
    if (s.t3) {
        document.getElementById('shift-3').style.display = 'block';
        document.getElementById('add-shift-btn').style.display = 'none';
    } else {
        document.getElementById('shift-3').style.display = 'none';
        document.getElementById('add-shift-btn').style.display = 'block';
    }
    
    document.getElementById('c-txt').value = s.txt || '';
    document.getElementById('modal').style.display = 'block';
}

function addShiftField() {
    document.getElementById('shift-3').style.display = 'block';
    document.getElementById('add-shift-btn').style.display = 'none';
}

function removeShiftField(num) {
    document.getElementById(`shift-${num}`).style.display = 'none';
    document.getElementById('add-shift-btn').style.display = 'block';
    
    // Î•ÎºÎºÎ±Î¸Î¬ÏÎ¹ÏƒÎ· Ï„Ï‰Î½ Ï€ÎµÎ´Î¯Ï‰Î½
    document.getElementById(`c-n${num}`).value = '';
    document.getElementById(`c-h${num}`).value = '';
    document.getElementById(`c-m${num}`).value = '';
}

function renderShifts() {
    const hr = (parseFloat(document.getElementById('salary').value) || 0) / 280;
    const grid = document.getElementById('m-opts');
    grid.innerHTML = '';
    
    SHIFTS.concat(customShifts).forEach(o => {
        let b = document.createElement('div');
        b.className = 'm-btn';
        b.innerHTML = `<span>${o.n}</span> <span class="m-hours">${o.h}Ï‰</span> <span class="m-rate">${(hr * o.s).toFixed(2)}â‚¬</span>`;
        b.onclick = () => {
            let t = activeInput;
            document.getElementById(t).value = o.n;
            document.getElementById(t.replace('n', 'h')).value = o.h;
            document.getElementById(t.replace('n', 'm')).value = (o.h * (o.isPrice ? o.s : hr * o.s)).toFixed(2);
            document.getElementById(t).dataset.isot = o.isOT ? "1" : "0";
            document.getElementById(t).dataset.mult = o.s;
            document.getElementById(t).dataset.isprice = o.isPrice ? "true" : "false";
            
            // Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î¼ÎµÏ„Î¬Î²Î±ÏƒÎ· ÏƒÏ„Î¿ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Ï€ÎµÎ´Î¯Î¿
            if (t === 'c-n1') activeInput = 'c-n2';
            else if (t === 'c-n2') {
                // Î•Î¬Î½ Î· 3Î· Î²Î¬ÏÎ´Î¹Î± ÎµÎ¯Î½Î±Î¹ Î¿ÏÎ±Ï„Î®, Ï€Î®Î³Î±Î¹Î½Îµ ÎµÎºÎµÎ¯
                if (document.getElementById('shift-3').style.display === 'block') {
                    activeInput = 'c-n3';
                } else {
                    activeInput = 'c-n1';
                }
            }
            else if (t === 'c-n3') activeInput = 'c-n1';
        };
        grid.appendChild(b);
    });
}

function addCustomShift() {
    let n = document.getElementById('cust-n').value;
    let h = parseFloat(document.getElementById('cust-h').value);
    let p = parseFloat(document.getElementById('cust-p').value);
    
    if (!n || isNaN(h) || isNaN(p)) return;
    
    customShifts.push({ n, h, s: p, isPrice: true });
    localStorage.setItem('exfr_custom_v133', JSON.stringify(customShifts));
    renderShifts();
}

function recalcMoney(num) {
    const hr = (parseFloat(document.getElementById('salary').value) || 0) / 280;
    const h = parseFloat(document.getElementById(`c-h${num}`).value) || 0;
    const mult = parseFloat(document.getElementById(`c-n${num}`).dataset.mult) || 0;
    const isPrice = document.getElementById(`c-n${num}`).dataset.isprice === "true";
    
    document.getElementById(`c-m${num}`).value = (h * (isPrice ? mult : hr * mult)).toFixed(2);
}

function save() {
    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î±Î½Ï„Î¹ÎºÎµÎ¹Î¼Î­Î½Î¿Ï… Î¼Îµ 3 Î²Î¬ÏÎ´Î¹ÎµÏ‚
    const shiftData = {
        t1: document.getElementById('c-n1').value,
        h1: parseFloat(document.getElementById('c-h1').value) || 0,
        m1: parseFloat(document.getElementById('c-m1').value) || 0,
        isOT1: document.getElementById('c-n1').dataset.isot === "1",
        
        t2: document.getElementById('c-n2').value,
        h2: parseFloat(document.getElementById('c-h2').value) || 0,
        m2: parseFloat(document.getElementById('c-m2').value) || 0,
        isOT2: document.getElementById('c-n2').dataset.isot === "1",
        
        txt: document.getElementById('c-txt').value
    };
    
    // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· 3Î·Ï‚ Î²Î¬ÏÎ´Î¹Î±Ï‚ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹
    if (document.getElementById('shift-3').style.display === 'block') {
        shiftData.t3 = document.getElementById('c-n3').value;
        shiftData.h3 = parseFloat(document.getElementById('c-h3').value) || 0;
        shiftData.m3 = parseFloat(document.getElementById('c-m3').value) || 0;
        shiftData.isOT3 = document.getElementById('c-n3').dataset.isot === "1";
    }
    
    // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î³Î¹Î± Î±Ï€Î¿Ï…ÏƒÎ¯ÎµÏ‚
    const isAbsent = SHIFTS.find(x => x.n === shiftData.t1)?.abs || 
                     SHIFTS.find(x => x.n === shiftData.t2)?.abs || 
                     SHIFTS.find(x => x.n === shiftData.t3)?.abs || false;
    
    shiftData.abs = isAbsent;
    
    db[selD] = shiftData;
    localStorage.setItem('exfr_db_v53', JSON.stringify(db));
    closeModal();
    calculate();
}

function del() {
    delete db[selD];
    localStorage.setItem('exfr_db_v53', JSON.stringify(db));
    closeModal();
    calculate();
}

function closeModal() {
    document.getElementById('modal').style.display = 'none';
}

function nav(v) {
    cur.setMonth(cur.getMonth() + v);
    calculate();
}

// Î‘ÏÏ‡Î¹ÎºÎ® Ï†ÏŒÏÏ„Ï‰ÏƒÎ·
if (!window.cordova) {
    document.addEventListener('DOMContentLoaded', calculate);
} else {
    document.addEventListener('deviceready', calculate, false);
}
</script>
</body>
</html>
